/* M0: Cohort (last 60 days) */
create or replace temp table NTX_COHORT_YTD as
select
    ma.EncounterKey,
    min(ma.AdminInstant) as First_Dose_Instant,
    max(ma.AdminInstant) as Last_Dose_Instant
from MedicationAdministrationFact ma
join MedicationDim md
  on ma.MedicationKey = md.MedicationKey
where ma.AdminInstant >= dateadd(day, -60, current_date)
  and md.MedicationName ilike any (array[
        '%gentamicin%', '%tobramycin%', '%amikacin%',
        '%vancomycin%', '%acyclovir%', '%amphotericin%',
        '%ibuprofen%', '%ketorolac%'
  ])
group by ma.EncounterKey;

/* M1: Labs (last 60 days) */
create or replace temp table Labs_Inputs_YTD as
select
    lcr.EncounterKey,
    lcd.LabComponentName,
    lcr.ResultInstant,
    lcr.NumericValue,
    lcr.Value as TextResult,
    lcr.Unit
from LabComponentResult lcr
join LabComponentDim lcd
  on lcr.LabComponentKey = lcd.LabComponentKey
where lcr.EncounterKey in (select EncounterKey from NTX_COHORT_YTD)
  and lcr.ResultInstant >= dateadd(day, -60, current_date)
  and lcd.LabComponentName ilike any (array[
        '%creatinine%', '%bun%', '%cystatin%',
        '%gentamicin level%', '%tobramycin level%',
        '%amikacin level%', '%vancomycin level%'
  ]);

/* K1: SCr series (windowed & â‰¤60d) */
create or replace temp view KDIGO_SCr_Series_YTD as
select
    l.EncounterKey,
    l.ResultInstant,
    coalesce(try_to_decimal(l.NumericValue),
             try_to_decimal(l.TextResult)) as SCr_mg_dL,
    l.Unit
from Labs_Inputs_YTD l
join NTX_COHORT_YTD c using (EncounterKey)
where l.LabComponentName ilike '%creatinine%'
  and l.ResultInstant >= dateadd(day, -60, current_date)
  and l.ResultInstant between dateadd(day,-7, c.First_Dose_Instant)
                          and dateadd(day,14, c.Last_Dose_Instant);

/* K2: Baseline */
create or replace temp view KDIGO_Baseline_YTD as
select EncounterKey, min(SCr_mg_dL) as Baseline_SCr
from KDIGO_SCr_Series_YTD
group by EncounterKey;

/* K3: First abnormal */
create or replace temp view KDIGO_FirstAbnormal_YTD as
select distinct
    s.EncounterKey,
    min_by(s.ResultInstant, s.SCr_mg_dL) as First_Abnormal_Instant
from KDIGO_SCr_Series_YTD s
join KDIGO_Baseline_YTD b using (EncounterKey)
where (s.SCr_mg_dL - b.Baseline_SCr) >= 0.3
   or  s.SCr_mg_dL >= (b.Baseline_SCr * 1.5)
group by s.EncounterKey;

/* K4: Peak */
create or replace temp view KDIGO_Peak_YTD as
select EncounterKey, max(SCr_mg_dL) as Peak_SCr
from KDIGO_SCr_Series_YTD
group by EncounterKey;

/* K5: Stage */
create or replace temp view KDIGO_Stage_YTD as
select
    b.EncounterKey,
    b.Baseline_SCr,
    p.Peak_SCr,
    case
        when p.Peak_SCr >= b.Baseline_SCr * 3
          or p.Peak_SCr >= 4.0 then 3
        when p.Peak_SCr >= b.Baseline_SCr * 2 then 2
        when p.Peak_SCr >= b.Baseline_SCr * 1.5
          or (p.Peak_SCr - b.Baseline_SCr) >= 0.3 then 1
        else 0
    end as KDIGO_Stage
from KDIGO_Baseline_YTD b
join KDIGO_Peak_YTD p using (EncounterKey);

/* ========================
   N1: Notes Context (last 60d, peri-exposure, focused services)
   ======================== */
create or replace temp view Notes_Context_YTD as
select
    cnf.EncounterKey,
    dd.DateValue as NoteDate,             -- from LastEditedDateKey
    cnf.ClinicalNoteKey,
    pd.ProviderTypeName as AuthorType,    -- via DurableKey (IsCurrent=1)
    cnf.Service,
    substr(cntf.NoteText, 1, 400) as NotePreview
from ClinicalNoteFact cnf
join ClinicalNoteTextFact cntf
  on cnf.ClinicalNoteKey = cntf.ClinicalNoteKey
join DateDim dd
  on cnf.LastEditedDateKey = dd.DateKey
left join ProviderDim pd
  on cnf.AuthoringProviderDurableKey = pd.DurableKey
 and pd.IsCurrent = 1
join NTX_COHORT_YTD c
  on cnf.EncounterKey = c.EncounterKey
where dd.DateValue >= dateadd(day, -60, current_date)
  and dd.DateValue between dateadd(day, -7, cast(c.First_Dose_Instant as date))
                      and dateadd(day, 14, cast(c.Last_Dose_Instant  as date))
  and (
       cnf.Service ilike 'Infectious Disease'
    or cnf.Service ilike 'Nephrology'
    or cnf.Service ilike 'Pharmacy'
    or cnf.Service ilike 'Critical Care Serv'
    or cnf.Service ilike 'Cardiac Intensive Care Unit'
    or cnf.Service ilike 'Pediatric Hospital Medicine'
    or cnf.Service ilike 'Emergency Dept'
    or cnf.Service ilike 'Oncology'
    or cnf.Service ilike 'Hematology Oncology'
    or cnf.Service ilike 'Cardiology'
    or cnf.Service ilike 'CV Surgery'
    or cnf.Service ilike 'Interventional Radiology'
    or cnf.Service ilike 'Medical Imaging'
    or cnf.Service ilike 'Neonatology'
    or cnf.Service ilike 'Heart Failure'
  );


/* Final view */
create or replace view NTX_AKI_With_Context as
select
  k5.EncounterKey,
  k5.Baseline_SCr,
  k5.Peak_SCr,
  k5.KDIGO_Stage,
  n.NoteInstant,
  n.ClinicalNoteTypeName,
  n.AuthorType,
  n.NotePreview
from KDIGO_Stage_YTD k5
left join Notes_Context_YTD n
  on k5.EncounterKey = n.EncounterKey;
